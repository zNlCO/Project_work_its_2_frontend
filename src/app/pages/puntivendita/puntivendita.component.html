<div class="page-container dark-theme punti-vendita-page">
  <header class="page-header">
    <h1><i class="fas fa-store-alt"></i> Gestione Punti Vendita</h1>
  </header>

  <section class="action-bar">
    <div class="search-container">
      <input 
        type="text" 
        placeholder="Cerca per nome o indirizzo..." 
        class="search-input dark-input"
        [(ngModel)]="searchTerm"
        (input)="onSearch()">
      <button class="btn btn-primary btn-search" (click)="onSearch()">
        <i class="fas fa-search"></i>
      </button>
    </div>
    <button class="btn btn-primary btn-add-location" (click)="openAddModal()">
      <i class="fas fa-plus"></i> Aggiungi Punto Vendita
    </button>
  </section>

  <section class="content-area">
    <div class="sales-points-grid" *ngIf="filteredSalesPoints.length > 0; else noResults">
      <div class="sales-point-card" *ngFor="let salesPoint of filteredSalesPoints">
        <div class="card-header">
          <h3>{{ salesPoint.name }}</h3>
          <span class="location-status" [class.active]="salesPoint.active" [class.inactive]="!salesPoint.active">
            {{ salesPoint.active ? 'Attivo' : 'Inattivo' }}
          </span>
        </div>
        <div class="card-body">
          <p class="location-address">
            <i class="fas fa-map-marker-alt"></i> {{ salesPoint.address }}
          </p>
          <div class="bike-inventory-summary">
            <h4><i class="fas fa-bicycle"></i> Inventario Bici ({{ getTotalBikes(salesPoint) }} totali):</h4>
            <ul *ngIf="salesPoint.bikes.length > 0">
              <li *ngFor="let bike of salesPoint.bikes">
                {{ bike.type }} ({{ bike.powerType }}) - {{ bike.size }}: <span>{{ bike.quantity }}</span>
              </li>
            </ul>
            <p class="no-inventory-text" *ngIf="salesPoint.bikes.length === 0">
              Nessuna bici assegnata.
            </p>
          </div>
        </div>
        <div class="card-actions">
          <button class="btn btn-icon btn-edit" title="Modifica Dati Punto Vendita" (click)="openEditModal(salesPoint)">
            <i class="fas fa-edit"></i> <span class="btn-text">Modifica</span>
          </button>
          <button class="btn btn-icon btn-manage-inventory" title="Gestisci Inventario Bici" (click)="openInventoryModal(salesPoint)">
            <i class="fas fa-tasks"></i> <span class="btn-text">Inventario Bici</span>
          </button>
          <button class="btn btn-icon btn-delete btn-danger" title="Elimina Punto Vendita" (click)="openDeleteModal(salesPoint)">
            <i class="fas fa-trash"></i> <span class="btn-text">Elimina</span>
          </button>
        </div>
      </div>
    </div>

    <ng-template #noResults>
      <div class="empty-state">
        <i class="fas fa-search"></i>
        <h3>Nessun punto vendita trovato</h3>
        <p *ngIf="searchTerm">Nessun risultato per "{{ searchTerm }}"</p>
        <p *ngIf="!searchTerm && salesPoints.length === 0">Non ci sono ancora punti vendita configurati.</p>
      </div>
    </ng-template>
  </section>

  <div class="modal-overlay" [class.show]="showAddModal" (click)="closeAllModals()">
    <div class="modal-dialog" (click)="$event.stopPropagation()" *ngIf="showAddModal">
      <div class="modal-header">
        <h3><i class="fas fa-plus"></i> Aggiungi Nuovo Punto Vendita</h3>
        <button class="btn-close" (click)="closeAllModals()"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <form *ngIf="newSalesPoint">
          <div class="form-group">
            <label for="newName">Nome Punto Vendita *</label>
            <input type="text" id="newName" class="form-control dark-input" [(ngModel)]="newSalesPoint.name" name="newName" placeholder="Es. Noleggio Centro Storico" required>
          </div>
          <div class="form-group">
            <label for="newAddress">Indirizzo *</label>
            <input type="text" id="newAddress" class="form-control dark-input" [(ngModel)]="newSalesPoint.address" name="newAddress" placeholder="Es. Via Roma, 1" required>
          </div>
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="newSalesPoint.active" name="newActive"> Punto vendita attivo
            </label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeAllModals()">Annulla</button>
        <button class="btn btn-primary" (click)="addSalesPoint()" [disabled]="!newSalesPoint.name || !newSalesPoint.address">Aggiungi</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" [class.show]="showEditModal" (click)="closeAllModals()">
    <div class="modal-dialog" (click)="$event.stopPropagation()" *ngIf="showEditModal && editingSalesPoint">
      <div class="modal-header">
        <h3><i class="fas fa-edit"></i> Modifica Punto Vendita</h3>
        <button class="btn-close" (click)="closeAllModals()"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="form-group">
            <label for="editName">Nome Punto Vendita *</label>
            <input type="text" id="editName" class="form-control dark-input" [(ngModel)]="editingSalesPoint.name" name="editName" required>
          </div>
          <div class="form-group">
            <label for="editAddress">Indirizzo *</label>
            <input type="text" id="editAddress" class="form-control dark-input" [(ngModel)]="editingSalesPoint.address" name="editAddress" required>
          </div>
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="editingSalesPoint.active" name="editActive"> Punto vendita attivo
            </label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeAllModals()">Annulla</button>
        <button class="btn btn-primary" (click)="updateSalesPoint()" [disabled]="!editingSalesPoint.name || !editingSalesPoint.address">Salva Modifiche</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" [class.show]="showInventoryModal" (click)="closeAllModals()">
    <div class="modal-dialog modal-lg" (click)="$event.stopPropagation()" *ngIf="showInventoryModal && selectedSalesPoint">
      <div class="modal-header">
        <h3><i class="fas fa-tasks"></i> Gestisci Inventario - {{ selectedSalesPoint.name }}</h3>
        <button class="btn-close" (click)="closeAllModals()"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <div class="inventory-actions">
          <button class="btn btn-primary btn-sm" (click)="openAddBikeModal()"><i class="fas fa-plus"></i> Aggiungi Bici</button>
        </div>
        <div class="inventory-table" *ngIf="selectedSalesPoint.bikes.length > 0">
          <table class="table dark-table">
            <thead>
              <tr><th>Tipo</th><th>Alimentazione</th><th>Taglia</th><th>Quantità</th><th>Azioni</th></tr>
            </thead>
            <tbody>
              <tr *ngFor="let bike of selectedSalesPoint.bikes; let i = index">
                <td>{{ bike.type }}</td><td>{{ bike.powerType }}</td><td>{{ bike.size }}</td><td>{{ bike.quantity }}</td>
                <td>
                  <button class="btn btn-icon btn-edit btn-sm" (click)="openEditBikeModal(bike, i)" title="Modifica"><i class="fas fa-edit"></i></button>
                  <button class="btn btn-icon btn-delete btn-danger btn-sm" (click)="deleteBike(i)" title="Elimina"><i class="fas fa-trash"></i></button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="empty-inventory" *ngIf="selectedSalesPoint.bikes.length === 0">
          <i class="fas fa-bicycle"></i><p>Nessuna bici in inventario</p>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" (click)="closeAllModals()">Chiudi</button></div>
    </div>
  </div>

  <div class="modal-overlay" [class.show]="showAddBikeModal" (click)="closeBikeModal()">
    <div class="modal-dialog" (click)="$event.stopPropagation()" *ngIf="showAddBikeModal && editingBike">
      <div class="modal-header">
        <h3><i class="fas fa-bicycle"></i> {{ editingBikeIndex === -1 ? 'Aggiungi' : 'Modifica' }} Bici</h3>
        <button class="btn-close" (click)="closeBikeModal()"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="form-row">
            <div class="form-group">
              <label for="bikeType">Tipo Bici *</label>
              <select id="bikeType" class="form-control dark-input" [(ngModel)]="editingBike.type" name="bikeType" required>
                <option value="">Seleziona tipo</option><option *ngFor="let type of bikeTypes" [value]="type">{{ type }}</option>
              </select>
            </div>
            <div class="form-group">
              <label for="bikePower">Alimentazione *</label>
              <select id="bikePower" class="form-control dark-input" [(ngModel)]="editingBike.powerType" name="bikePower" required>
                <option *ngFor="let power of powerTypes" [value]="power">{{ power }}</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="bikeSize">Taglia *</label>
              <select id="bikeSize" class="form-control dark-input" [(ngModel)]="editingBike.size" name="bikeSize" required>
                <option *ngFor="let size of bikeSizes" [value]="size">{{ size }}</option>
              </select>
            </div>
            <div class="form-group">
              <label for="bikeQuantity">Quantità *</label>
              <input type="number" id="bikeQuantity" class="form-control dark-input" [(ngModel)]="editingBike.quantity" name="bikeQuantity" min="1" required>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeBikeModal()">Annulla</button>
        <button class="btn btn-primary" (click)="saveBike()" [disabled]="!editingBike.type || !editingBike.powerType || !editingBike.size || !editingBike.quantity">{{ editingBikeIndex === -1 ? 'Aggiungi' : 'Salva' }}</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" [class.show]="showDeleteModal" (click)="closeAllModals()">
    <div class="modal-dialog modal-sm" (click)="$event.stopPropagation()" *ngIf="showDeleteModal && selectedSalesPoint">
      <div class="modal-header">
        <h3><i class="fas fa-exclamation-triangle"></i> Conferma Eliminazione</h3>
        <button class="btn-close" (click)="closeAllModals()"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <p>Sei sicuro di voler eliminare il punto vendita <strong>"{{ selectedSalesPoint.name }}"</strong>?</p>
        <p class="warning-text"><i class="fas fa-exclamation-triangle"></i> Questa azione non può essere annullata.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeAllModals()">Annulla</button>
        <button class="btn btn-danger" (click)="deleteSalesPoint()"><i class="fas fa-trash"></i> Elimina</button>
      </div>
    </div>
  </div>
  
  <footer class="backoffice-page-footer dark-theme">
    <p>&copy; 2025 Bike Rental System - Backoffice</p>
  </footer>
</div>