<div class="container mt-5 py-5">
    <!-- Step Indicator -->
    <div class="d-flex justify-content-center mb-4">
        <div class="step-circle me-3" (click)="confirmGoBack()" [ngClass]="{ 'active-step': currentStep === 1 }">1</div>
        <div class="step-circle" [ngClass]="{ 'active-step': currentStep === 2 }">2</div>
    </div>

    <!-- Step 1 -->
    <div *ngIf="currentStep === 1">
        <!-- Luogo di ritiro -->
        <div class="mb-3">
            <label class="form-label bai-jamjuree-semibold text-black">Luogo di ritiro</label>
            <select class="form-select" [(ngModel)]="pickupLocation" name="pickupLocation"
                (ngModelChange)="autoFillDropoff()" required>
                <option value="" disabled>Seleziona luogo di ritiro</option>
                <option *ngFor="let store of stores" [ngValue]="store">{{ store.location }}</option>
            </select>
        </div>

        <!-- Luogo di consegna -->
        <div class="mb-3">
            <label class="form-label bai-jamjuree-semibold text-black">Luogo di consegna</label>
            <select class="form-select" [(ngModel)]="dropoffLocation">
                <option value="" disabled selected>Seleziona luogo di ritiro</option>
                <option *ngFor="let store of stores" [ngValue]="store">{{ store.location }}</option>
            </select>
        </div>

        <!-- Data e ora di ritiro -->
        <div class="mb-3">
            <label class="form-label bai-jamjuree-semibold text-black">Data di ritiro</label>
            <input type="date" class="form-control" [(ngModel)]="pickupDate" (change)="checkDates()">
        </div>

        <div class="mb-3">
            <label class="form-label bai-jamjuree-semibold text-black">Ora di ritiro</label>
            <select class="form-select" [(ngModel)]="pickupTime" (change)="checkDates()">
                <option *ngFor="let hour of hours" [value]="hour">{{ hour }}</option>
            </select>
        </div>

        <!-- Data e ora di consegna -->
        <div class="mb-3">
            <label class="form-label bai-jamjuree-semibold text-black">Data di consegna</label>
            <input type="date" class="form-control" [(ngModel)]="dropoffDate" (change)="checkDates()">
        </div>

        <div class="mb-3">
            <label class="form-label bai-jamjuree-semibold text-black">Ora di consegna</label>
            <select class="form-select" [(ngModel)]="dropoffTime" (change)="checkDates()">
                <option *ngFor="let hour of hours" [value]="hour">{{ hour }}</option>
            </select>
        </div>

        <!-- Messaggio di errore -->
        <div *ngIf="invalidDateRange" class="alert alert-danger p-2">
            La data e l'ora di consegna devono essere successive a quelle di ritiro.
        </div>

        <!-- Pulsante continua -->
        <div class="text-end">
            <button class="btn my-red-btn bai-jamjuree-semibold mt-3"
                [disabled]="!pickupLocation || !dropoffLocation || !pickupDate || !dropoffDate || !pickupTime || !dropoffTime || invalidDateRange"
                (click)="goToStep(2)">Continua</button>
        </div>
    </div>

    <!-- Step 2 -->
    <div *ngIf="currentStep === 2">
        <div class="container py-4">
            <div class="row bg-light rounded shadow p-4 mb-4">
                <!-- Riepilogo dati prima tab -->
                <div class="col-12 mb-3">
                    <div class="card shadow-sm border-0 rounded-4 bg-white px-4 py-3 position-relative">
                        <h5 class="bai-jamjuree-semibold text-danger mb-3">
                            <i class="fas fa-receipt me-2"></i> Dati prenotazione
                        </h5>
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <span class="badge bg-danger-subtle text-danger-emphasis me-2">
                                    <i class="fas fa-map-marker-alt"></i>
                                </span>
                                <strong>Luogo ritiro:</strong>
                                <span class="ms-1">{{ pickupLocation?.location }}</span>
                            </li>
                            <li class="mb-2">
                                <span class="badge bg-danger-subtle text-danger-emphasis me-2">
                                    <i class="fas fa-location-arrow"></i>
                                </span>
                                <strong>Luogo consegna:</strong>
                                <span class="ms-1">{{ dropoffLocation?.location }}</span>
                            </li>
                            <li class="mb-2">
                                <span class="badge bg-danger-subtle text-danger-emphasis me-2">
                                    <i class="fas fa-calendar-alt"></i>
                                </span>
                                <strong>Data ritiro:</strong>
                                <span class="ms-1">{{ pickupDate }}</span>
                                <span class="badge bg-secondary-subtle text-secondary-emphasis ms-2">
                                    <i class="fas fa-clock"></i> {{ pickupTime }}
                                </span>
                            </li>
                            <li>
                                <span class="badge bg-danger-subtle text-danger-emphasis me-2">
                                    <i class="fas fa-calendar-check"></i>
                                </span>
                                <strong>Data consegna:</strong>
                                <span class="ms-1">{{ dropoffDate }}</span>
                                <span class="badge bg-secondary-subtle text-secondary-emphasis ms-2">
                                    <i class="fas fa-clock"></i> {{ dropoffTime }}
                                </span>
                            </li>
                        </ul>
                        <button class="btn my-red-btn-opposite mt-4 position-absolute end-0 bottom-0 me-3 mb-3"
                            (click)="confirmGoBack()">
                            <i class="fas fa-pen me-1"></i> Modifica dati
                        </button>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0 rounded-4 bg-white p-4 d-flex flex-row align-items-center my-4">
                <!-- Immagine bici -->
                <div class="me-4 flex-shrink-0" style="width: 180px;">
                    <img [src]="selectedBike?.idModello?.imgUrl" alt="Immagine bici" class="img-fluid rounded"
                        style="max-height: 160px; object-fit: cover; background: #f8f9fa;" />
                </div>
                <!-- Dati bici -->
                <div class="flex-grow-1">
                    <h4 class="bai-jamjuree-bold-italic text-danger mb-2">{{ selectedBike?.idModello?.type }}</h4>
                    <div class="mb-2 text-secondary">{{ selectedBike?.idModello?.descrizione }}</div>
                    <div class="mb-2">
                        <span class="badge bg-dark-subtle text-dark-emphasis me-2">
                            <i class="fas fa-euro-sign"></i> {{ selectedBike?.idModello?.prezzo | number:'1.2-2' }}
                            /giorno
                        </span>
                        <span class="badge bg-secondary-subtle text-secondary-emphasis me-2">
                            <i class="fas fa-ruler-combined"></i> Taglia: {{ selectedBike?.idModello?.size }}
                        </span>
                        <span class="badge bg-success-subtle text-success-emphasis"
                            *ngIf="selectedBike?.idModello?.elettrica">
                            <i class="fas fa-bolt"></i> Elettrica
                            <i class="fas fa-check-circle ms-1"></i>
                        </span>
                        <span class="badge bg-secondary-subtle text-secondary-emphasis"
                            *ngIf="!selectedBike?.idModello?.elettrica">
                            <i class="fas fa-bicycle"></i> Muscolare
                        </span>
                    </div>
                    <!-- Accessori -->
                    <div class="mb-2 mt-3">
                        <label class="form-label fw-semibold">Accessorio:</label>
                        <select class="form-select w-auto d-inline-block ms-2" [(ngModel)]="selectedAccessory"
                            name="accessory" required>
                            <option value="" disabled selected>Scegli accessorio</option>
                            <option>Luci LED</option>
                            <option>Porta smartphone universale</option>
                            <option>Lucchetto antifurto</option>
                            <option>Caschetto standard</option>
                        </select>
                    </div>
                    <!-- Assicurazione -->
                    <div class="mb-2">
                        <label class="form-label fw-semibold">Assicurazione:</label>
                        <select class="form-select w-auto d-inline-block ms-2" [(ngModel)]="selectedInsurance"
                            name="insurance" required>
                            <option value="" disabled selected>Scegli assicurazione</option>
                            <option>Assicurazione base (danni fino a 200 €)</option>
                            <option>Servizio emergenza (recupero entro 50 km)</option>
                            <option>Kasko completa (danni illimitati + emergenza)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- SEZIONE AGGIUNTA BICI A PRENOTAZIONE: lista bici disponibili -->
            <div class="container">
                <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 g-4">
                    <div class="col" *ngFor="let bike of bikeDisponibili">
                        <div
                            class="bike-card-custom p-3 text-center h-100 d-flex flex-column justify-content-between shadow-sm">
                            <img [src]="bike.idModello.imgUrl" alt="Immagine bici"
                                class="img-fluid rounded bike-img mb-3"
                                style="max-height: 160px; object-fit: cover; background: #f8f9fa;" />
                            <div class="mb-2 text-break">
                                <h5 class="bai-jamjuree-bold-italic text-danger mb-1">{{ bike.idModello.type ||
                                    'N/A' }}</h5>
                                <div class="small text-secondary mb-1">{{ bike.idModello.descrizione || 'N/A' }}
                                </div>
                                <div class="fw-bold text-success fs-5 mt-2">
                                    € {{ bike.idModello.prezzo | number:'1.2-2' }}
                                    <span class="fs-6 text-secondary">/ora</span>
                                </div>
                            </div>
                            <button class="btn my-red-btn bai-jamjuree-semibold mt-3 w-100"
                                (click)="selectBike(bike)">Scegli</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pulsanti -->
        <div class="d-flex justify-content-between">
            <button class="btn my-red-btn-opposite bai-jamjuree-semibold" (click)="confirmGoBack()">Indietro</button>
            <button class="btn my-red-btn bai-jamjuree-semibold">Prenota</button>
        </div>
    </div>
</div>